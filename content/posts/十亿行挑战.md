+++
title = 'åäº¿è¡ŒæŒ‘æˆ˜'
date = 2024-11-23T15:49:21+08:00
tags = [ "Go" ]
draft = false
+++

> åäº¿è¡ŒæŒ‘æˆ˜ï¼ˆ1ï¸âƒ£ğŸğŸï¸ The One Billion Row Challengeï¼‰
>
> åŸå§‹[ä»“åº“](https://github.com/gunnarmorling/1brc)

## ç›®æ ‡

æ–‡æœ¬æ–‡ä»¶åŒ…å«äº†ä¸€ç³»åˆ—æ°”è±¡ç«™çš„æ¸©åº¦å€¼ã€‚æ¯è¡Œæ˜¯ä¸€ä¸ªæµ‹é‡å€¼ï¼Œæ ¼å¼ä¸º`<string: station name>;<double: measurement>`ï¼Œå…¶ä¸­æµ‹é‡å€¼ç²¾ç¡®åˆ°ä¸€ä½å°æ•°ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹è¡Œï¼š

```txt
Hamburg;12.0
Bulawayo;8.9
Palembang;38.8
St. John's;15.2
Cracow;12.6
Bridgetown;26.9
Istanbul;6.2
Roseau;34.4
Conakry;31.2
Istanbul;23.0
```

ä»»åŠ¡æ˜¯ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œè¯¥ç¨‹åºè¯»å–æ–‡æœ¬æ–‡ä»¶ï¼Œè®¡ç®—æ¯ä¸ªæ°”è±¡ç«™çš„æœ€ä½ã€å¹³å‡å’Œæœ€é«˜æ¸©åº¦å€¼ï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°`stdout`ï¼Œ
æ ¼å¼å¦‚ä¸‹ï¼ˆæŒ‰æ°”è±¡ç«™åç§°å­—æ¯é¡ºåºæ’åºï¼Œå¹¶ä¸”æ¯ä¸ªæ°”è±¡ç«™çš„ç»“æœå€¼æ ¼å¼ä¸º`<min>/<mean>/<max>`ï¼Œä¿ç•™ä¸€ä½å°æ•°ç‚¹ï¼‰ï¼š

```
{Abha=-23.0/18.0/59.2, Abidjan=-16.2/26.0/67.3, AbÃ©chÃ©=-10.0/29.4/69.0, Accra=-10.1/26.4/66.4, Addis Ababa=-23.7/16.0/67.0, Adelaide=-27.8/17.3/58.5, ...}
```

## é™åˆ¶

> åªèƒ½ä½¿ç”¨æ ‡å‡†åº“å®ç°ã€‚

### ç”Ÿæˆåäº¿è¡ŒæŒ‘æˆ˜æ‰€éœ€çš„æ•°æ®

å…‹éš†åŸå§‹[ä»“åº“](https://github.com/gunnarmorling/1brc)ï¼š

```shell
git clone https://github.com/gunnarmorling/1brc
cd 1brc/src/main/python
python3 create_measurements.py 1000000000
```

ç”Ÿæˆçš„æ•°æ®ä¼šåœ¨`1brc/measurements.txt`ï¼Œçº¦ä¸º`15Gi`çš„å¤§å°ã€‚

## å®ç°

æœºå™¨é…ç½®ï¼š

```txt
goos: darwin
goarch: arm64
pkg: demo
cpu: Apple M2
core: 8
```

ä¸‹é¢æ˜¯ä¸€æ­¥æ­¥è¿›è¡Œä¼˜åŒ–çš„é¡ºåºï¼š

### 1. åŸºç¡€ç»“æœ

å°†ç”Ÿæˆçš„`measurements.txt`æ–‡ä»¶è½¯é“¾åˆ°å½“å‰ç›®å½•ï¼š

```shell
ln -s <path>/1brc/data/measurements.txt measurements.txt
```

å…ˆç¼–è¯‘ï¼Œç„¶åå†æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å¿½ç•¥æ‰ç¼–è¯‘æ‰€é€ æˆçš„è€—æ—¶ï¼š

```shell
go build -o base.out baseline/main.go
./base.out measurements.txt > base.txt
```

`base.txt`æ˜¯åŸºçº¿ç»“æœï¼Œåç»­çš„ä¼˜åŒ–å¯ä»¥å’Œè¿™ä¸ªç»“æœè¿›è¡Œå¯¹æ¯”ã€‚

è¿™å°†ä¼šæ‰“å°æ¯«ç§’çš„è€—æ—¶ä¿¡æ¯ï¼Œæ‰§è¡Œä¸‰æ¬¡ï¼Œå–å…¶å¹³å‡æ•°ä¸º`135656`æ¯«ç§’ï¼Œè€—æ—¶çº¦ä¸º`135.66ç§’`ã€‚

| ç¨‹åº     | è€—æ—¶ï¼ˆmsï¼‰ |
| -------- | ---------- |
| baseline | 135656     |

### 2. åç¨‹

å°†æ–‡ä»¶åˆ†å—ï¼Œå¹¶ä½¿ç”¨åç¨‹è¿›è¡Œå¤„ç†ã€‚åç¨‹æ•°é‡éœ€è¦è°ƒè¯•å‡ºä¸€ä¸ªåˆé€‚çš„å€¼ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯`25`ã€‚

```shell
go build -o go.out goroutine/main.go
./go.out measurements.txt > go.txt
```

å’Œ`base.txt`è¿›è¡Œå¯¹æ¯”ï¼Œçœ‹æ˜¯å¦æœ‰å·®å¼‚ï¼š

```shell
diff --side-by-side --suppress-common-lines base.txt go.txt
```

å‘½ä»¤çš„è¾“å‡ºç»“æœåº”è¯¥æ˜¾ç¤ºæ²¡æœ‰å·®å¼‚ï¼Œå¹¶ä¸”å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç ä¸º`0`ã€‚

å–ä¸‰æ¬¡ç»“æœçš„å¹³å‡æ•°çº¦ä¸º`36818`æ¯«ç§’ï¼Œè€—æ—¶ä¸º`36.812ç§’`ã€‚å‡å°‘äº†çº¦`98.84ç§’`ã€‚

| ç¨‹åº      | è€—æ—¶ï¼ˆmsï¼‰ |
| --------- | ---------- |
| baseline  | 135656     |
| goroutine | 36818      |

### 3 æ›´å¤šä¼˜åŒ–

#### 3.1

ä¸ä½¿ç”¨`scanner`ï¼Œæ”¹ä¸ºç›´æ¥è¯»å–å›ºå®šç¼“å†²åŒºçš„æ–¹æ¡ˆã€‚

è¿™æ ·åšå¯ä»¥å‡å°‘å¯¹`line`å’Œ`args`çš„å†…å­˜åˆ†é…ï¼Œç›´æ¥å¼•ç”¨`buffer`çš„å†…å­˜ï¼Œå»¶ååˆ°å¯¹`map`æ“ä½œæ—¶å†è§£æã€‚
æ‰‹åŠ¨è§£æ`æ¢è¡Œç¬¦`å’Œ`åŸå¸‚`ã€`æ¸©åº¦`ï¼Œå¼•ç”¨`buffer`çš„å†…å­˜ï¼Œä¹Ÿå¯ä»¥å‡å°‘ç›´æ¥åˆ†é…ã€‚

```go
func scan(r io.Reader, meas map[string]*Meas) {
    buffer := make([]byte, BufferSize)
    remain := make([]byte, 0, BufferSize)
    for {
        n, _ := r.Read(buffer[:len(buffer)-len(remain)])
        if n == 0 {
            break
        }

		remain = append(remain, buffer[:n]...)

		var (
			cityByte []byte
			tempByte []byte
			next     bool
			newBuf   = remain
		)
		for {
			cityByte, tempByte, newBuf, next = parseLine(newBuf)
			if !next { // æ²¡æœ‰ä¸‹ä¸€è¡Œï¼Œé€€å‡ºå¾ªç¯é‡æ–°è¯»å–
				copy(remain, newBuf)
				remain = remain[:len(newBuf)]
				break
			}
			city := string(cityByte)
			temp, _ := strconv.ParseFloat(string(tempByte), 64)

			v, ok := meas[city]
			if !ok {
				v = &Meas{}
				meas[city] = v
			}
			v.min = min(temp, v.min)
			v.max = max(temp, v.max)
			v.sum += temp
			v.count += 1
		}
	}
}

func parseLine(buffer []byte) (city []byte, temp []byte, buf []byte, next bool) {
    end := 0
    for i, b := range buffer {
        if b != '\n' {
            continue
        }

		next = true
		end = i
		break
	}

	if !next {
		buf = buffer
		return
	}

	idx := 0
	for i, b := range buffer[:end] {
		if b == ';' {
			idx = i
			break
		}
	}
	city = buffer[:idx]
	temp = buffer[idx+1 : end]
	buf = buffer[end+1:]
	return
}
```

å¹³å‡è€—æ—¶çº¦ä¸º`17497`æ¯«ç§’ï¼Œ`17.50ç§’`ã€‚å‡å°‘äº†çº¦`19.32ç§’`ã€‚

| ç¨‹åº        | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------- | ---------- |
| baseline    | 135656     |
| goroutine   | 36818      |
| goroutine-1 | 17497      |

#### 3.2

ç°åœ¨ï¼Œæ¯æ¬¡`city`éƒ½éœ€è¦è½¬ä¸º`string`ï¼ˆ`city := string(cityByte)`ï¼‰ï¼Œç„¶åå†å»mapä¸­æŸ¥è¯¢ï¼Œè¿™æ ·ä¼šå¹³ç™½å¢åŠ ä¸€æ¬¡ä¸å¿…è¦çš„å†…å­˜åˆ†é…ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ–°çš„`hash`å‡½æ•°ç”Ÿæˆ`key`ã€‚

åœ¨`go`æ ‡å‡†åº“ä¸­ï¼Œæœ‰`hash/fnv`å’Œ`hash/maphash`ï¼Œç»è¿‡æµ‹è¯•ï¼Œ`fnv`çš„é€Ÿåº¦å¿«ä¸€äº›ã€‚

ä½¿ç”¨`fnv`é‡æ„ï¼ˆ`map`çš„`key`ç±»å‹ä¹Ÿè¦è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼‰ï¼Œè¿™æ ·`city`åªéœ€è¦åˆ†é…ä¸€æ¬¡å³å¯ï¼š

```go
    hash.Reset()
    _, _ = hash.Write(cityByte)
    key := hash.Sum64()
    temp, _ := strconv.ParseFloat(string(tempByte), 64)

    v, ok := meas[key]
    if !ok {
        v = &Meas{city: string(cityByte)}
        meas[key] = v
    }
    v.min = min(temp, v.min)
    v.max = max(temp, v.max)
    v.sum += temp
    v.count += 1
```

å¹³å‡è€—æ—¶çº¦ä¸º`13060.66`æ¯«ç§’ï¼Œ`13.06ç§’`ã€‚å‡å°‘äº†çº¦`4.437ç§’`ã€‚

| ç¨‹åº        | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------- | ---------- |
| baseline    | 135656     |
| goroutine   | 36818      |
| goroutine-1 | 17497      |
| goroutine-2 | 13060      |

#### 3.3

é€šè¿‡`go`çš„`pprof`æ¥æŸ¥çœ‹ç«ç„°å›¾ï¼Œè¿›è¡Œé’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚åœ¨`main`å‡½æ•°ä¸­å¢åŠ ä»¥ä¸‹ä»£ç ï¼Œä»¥å¯ç”¨`cpu pprof`ï¼š

```go
...

f, err := os.Create("cpu.prof")
if err != nil {
    log.Fatal(err)
}
defer func() {
    _ = f.Close()
}()
if err := pprof.StartCPUProfile(f); err != nil {
    log.Fatal(err)
}
defer pprof.StopCPUProfile()

multiProcess(data, chunks)
```

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ï¼š

```shell
go tool pprof -http=:8080 cpu.prof
```

ç«ç„°å›¾ï¼š
![img.png](/img/flame-graph.png)
é€šè¿‡æŸ¥çœ‹ç«ç„°å›¾å¯ä»¥å‘ç°ï¼Œ`strconv.ParseFloat`æ¯”è¾ƒè€—æ—¶ï¼Œå®˜æ–¹çš„å®ç°ä¼šæ¶‰åŠå¾ˆå¤šçš„å¤„ç†ï¼Œä½†æ˜¯å…¶å®æˆ‘ä»¬éƒ½ä¸éœ€è¦ï¼Œåªæ˜¯å‡è®¾å…¨æ˜¯æ ‡å‡†çš„æµ®ç‚¹æ•°å°±è¡Œï¼Œç±»ä¼¼`-1.2`ï¼Œåªæœ‰ä¸€ä½å°æ•°ã€‚

æ—¢ç„¶å‡è®¾æ•°æ®æ˜¯æ ‡å‡†çš„äº†ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆå°†`[]byte`çš„æµ®ç‚¹æ•°ï¼Œè½¬ä¸ºæ•´æ•°ï¼Œæœ€åè®¡ç®—çš„æ—¶å€™å†è½¬ä¸ºä¿ç•™ä¸€ä½å°æ•°çš„æµ®ç‚¹æ•°å¤„ç†ï¼š

```go
func parseNumber(data []byte) int64 {
	var (
		result     int64
		isNegative bool
	)
	for _, b := range data {
		if b == '-' {
			isNegative = true
			continue
		}

		if b >= '0' && b <= '9' {
			result = result*10 + int64(b-'0')
		}
	}
	if isNegative {
		result = -result
	}
	return result
}
```

å¹³å‡è€—æ—¶çº¦ä¸º`10576.33`æ¯«ç§’ï¼Œ`10.58ç§’`ã€‚å‡å°‘äº†çº¦`2.48ç§’`ã€‚

| ç¨‹åº        | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------- | ---------- |
| baseline    | 135656     |
| goroutine   | 36818      |
| goroutine-1 | 17497      |
| goroutine-2 | 13060      |
| goroutine-3 | 10576      |

#### 3.4

è°ƒæ•´`rectifyChunk`ä¸­çš„æ ¡æ­£ç»“æŸè¡Œçš„é€»è¾‘ï¼Œå‡å°‘ä¸€æ¬¡è¯»å–çš„`buffer`ä¸º`128`ï¼Œä¸€è¡Œæ•°æ®ä¸ä¼šå¾ˆé•¿ã€‚

```go
bufio.NewReaderSize(file, 128).ReadBytes('\n')
```

å¹³å‡è€—æ—¶çº¦ä¸º`10400.66`æ¯«ç§’ï¼Œ`10.40ç§’`ã€‚å‡å°‘äº†çº¦`175.67æ¯«ç§’`ã€‚

| ç¨‹åº        | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------- | ---------- |
| baseline    | 135656     |
| goroutine   | 36818      |
| goroutine-1 | 17497      |
| goroutine-2 | 13060      |
| goroutine-3 | 10576      |
| goroutine-4 | 10400      |

#### 3.5

é€šè¿‡ä¸€ç•ªæœç´¢å’ŒæŸ¥é˜…èµ„æ–™ï¼Œå‘ç°å¯ä»¥å†æ¬¡ä¼˜åŒ–`hash`é€Ÿåº¦ï¼ˆå‚è€ƒè¿™ä¸ª[æ–‡ç« ](https://theartincode.stanis.me/008-djb2/)ï¼‰ã€‚

```go
func hash(name []byte) uint64 {
    var h uint64 = 5381
    for _, b := range name {
        h = (h << 5) + h + uint64(b)
    }
    return h
}
```

å¹³å‡è€—æ—¶çº¦ä¸º`10092.33`æ¯«ç§’ï¼Œ`10.09ç§’`ã€‚å‡å°‘äº†çº¦`308æ¯«ç§’`ã€‚

| ç¨‹åº        | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------- | ---------- |
| baseline    | 135656     |
| goroutine   | 36818      |
| goroutine-1 | 17497      |
| goroutine-2 | 13060      |
| goroutine-3 | 10576      |
| goroutine-4 | 10400      |
| goroutine-5 | 10092      |

#### 3.6

åœ¨`go1.24`ä¸­ï¼Œé»˜è®¤çš„`map`å®ç°æ”¹ä¸ºä½¿ç”¨`swiss map`ï¼Œé€Ÿåº¦åˆèƒ½å¸¦æ¥æå‡ã€‚ç”±äº`go1.24`è¿˜æœªå‘å¸ƒï¼ˆ2025.01.20ï¼‰ï¼Œå¯ä»¥å…ˆä½¿ç”¨`gotip`æ„å»ºï¼š

```shell
gotip build -o opt.out optimize/main.go
./opt.out measurements.txt > opt.txt
```

å¹³å‡è€—æ—¶çº¦ä¸º`8271.33`æ¯«ç§’ï¼Œ`8.27ç§’`ã€‚å‡å°‘äº†çº¦`1.82ç§’`ã€‚

| ç¨‹åº                    | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------------------- | ---------- |
| baseline                | 135656     |
| goroutine               | 36818      |
| goroutine-1             | 17497      |
| goroutine-2             | 13060      |
| goroutine-3             | 10576      |
| goroutine-4             | 10400      |
| goroutine-5             | 10092      |
| goroutine-6ï¼ˆswissmapï¼‰ | 8271       |

## æœ€ç»ˆæˆæœ

å¹³å‡è€—æ—¶çº¦ä¸º`8271.33`æ¯«ç§’ï¼Œ`8.27ç§’`ã€‚

| ç¨‹åº                    | è€—æ—¶ï¼ˆmsï¼‰ |
| ----------------------- | ---------- |
| baseline                | 135656     |
| goroutine               | 36818      |
| goroutine-1             | 17497      |
| goroutine-2             | 13060      |
| goroutine-3             | 10576      |
| goroutine-4             | 10400      |
| goroutine-5             | 10092      |
| goroutine-6ï¼ˆswissmapï¼‰ | 8271       |

å¯¹æ¯”æœ€åˆçš„`baseline`å®ç°ï¼Œæ€§èƒ½æå‡äº†çº¦`16.40`å€ã€‚
